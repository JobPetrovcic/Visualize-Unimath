name: Get latest release version
on:
  schedule:
    - cron: "*/10 * * * *"
jobs:
  check-if-modified:
    runs-on: ubuntu-latest
    outputs:
      modified: ${{steps.check-latest.outputs.modified }}
    steps:
      - name: Download Artifact
        uses: actions/upload-artifact@v4
        with:
          name: last_commit
          path: .
      - name: check-latest
        id: check-latest
        run: |
          current_commit=$(curl -sL https://api.github.com/repos/JobPetrovcic/agda-unimath/commits | jq -r '.[0].sha')
          echo ::set-output name=modified::$(if [ "$current_commit" = "$(cat last_commit.txt)" ]; then echo false; else echo true; fi)
          echo $current_commit > last_commit.txt
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: last_commit
          path: ./last_commit.txt

  check:
    name: Visualize library
    runs-on: ubuntu-latest
    needs: check-if-modified
    if: ${{ needs.check-if-modified.outputs.modified }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: JobPetrovcic/agda-unimath
          ref: master
          path: mylib
      - uses: actions/checkout@v4
        with:
          repository: JobPetrovcic/agda-proof-assistent-assistent
          token: ${{ secrets.ACCESSPROOFASSISTANT }}
          ref: master
          path: agda-proof-assistent-assistent
      - uses: JobPetrovcic/Mathematical-Library-Vizualizer@main
        with:
          language: agda
          file_type: src/everything.lagda.md
          mode: standalone
          install_libs: no
          additional_commands: "make src/everything.lagda.md"
      - uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.ACCESSPROOFASSISTANT }}
        with:
          source-directory: "output"
          destination-github-username: "JobPetrovcic"
          destination-repository-name: "JobPetrovcic.github.io"
          user-email: job1.petrovcic@gmail.com
          target-branch: main
